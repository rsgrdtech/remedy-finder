<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remedy Search Application</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1, h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        #refreshBtn {
            background: #e67e22;
        }
        
        #refreshBtn:hover {
            background: #d35400;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .remedy-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .remedy-item.available {
            border-left: 4px solid #27ae60;
        }
        
        .remedy-item.unavailable {
            border-left: 4px solid #e74c3c;
        }
        
        .details-panel {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .label {
            font-weight: bold;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Remedy Search Application</h1>
            <div class="input-group">
                <input type="text" id="searchInput" placeholder="Search remedies...">
                <button id="searchBtn">Search</button>
                <button id="refreshBtn">Refresh Data</button>
            </div>
            <div id="status" class="status loading">Loading data from Google Sheets...</div>
        </div>
        
        <div class="results-grid">
            <div class="card">
                <h2>Search Results</h2>
                <div id="resultsContainer">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        Loading remedies...
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Remedy Details</h2>
                <div id="detailsPanel" class="details-panel">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        Select a remedy to view details
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple configuration
        const SHEET_ID = '11aZgt8hafBHfu0ZHeuyQH_MS09791YHXy_r-7LWc8KM';
        
        // DOM elements
        const searchBtn = document.getElementById('searchBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('resultsContainer');
        const detailsPanel = document.getElementById('detailsPanel');
        const statusDiv = document.getElementById('status');
        
        let remediesData = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', loadData);
        
        // Event listeners
        searchBtn.addEventListener('click', performSearch);
        refreshBtn.addEventListener('click', loadData);
        searchInput.addEventListener('input', performSearch);
        
        // Load data function
        async function loadData() {
            try {
                showStatus('Loading data from Google Sheets...', 'loading');
                refreshBtn.disabled = true;
                
                // Try direct CSV access first
                const csvUrl = https://docs.google.com/spreadsheets/d/e/2PACX-1vTKnCNTL2WzTz9aOp-RrjlK_uO3rV9SlKbng2BQ5KKyCsPjTO0CAij58lr9JbAi-c3d0KBBa-XYUJZI/pub?gid=369787331&single=true&output=csv
		//const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
                
                console.log('Fetching from:', csvUrl);
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('Raw CSV data:', csvText.substring(0, 500) + '...');
                
                remediesData = parseCSV(csvText);
                console.log('Parsed data:', remediesData);
                
                if (remediesData.length === 0) {
                    throw new Error('No data found in sheet');
                }
                
                showStatus(`Successfully loaded ${remediesData.length} remedies`, 'success');
                performSearch();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showStatus('Error loading from Google Sheets. Using sample data.', 'error');
                useSampleData();
            } finally {
                refreshBtn.disabled = false;
            }
        }
        
        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                console.log('Not enough lines in CSV');
                return [];
            }
            
            // Parse headers
            const headers = parseCSVLine(lines[0]);
            console.log('Headers:', headers);
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                if (values.length !== headers.length) {
                    console.log('Skipping line - column count mismatch:', values);
                    continue;
                }
                
                const item = {};
                headers.forEach((header, index) => {
                    item[header] = values[index] || '';
                });
                
                // Validate required fields
                if (item['Remedy Name'] && item['Potency']) {
                    data.push(item);
                }
            }
            
            return data;
        }
        
        // Proper CSV line parsing
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current.trim());
            return values;
        }
        
        // Use sample data as fallback
        function useSampleData() {
            remediesData = [
                {
                    "Remedy Name": "Arnica Montana",
                    "Potency": "30C",
                    "BOX Number": "B12",
                    "Type": "Pellets",
                    "Bottle Size": "30ml",
                    "BottleCapColor": "Blue",
                    "Manufacturer Brand": "Boiron",
                    "Available": "Yes",
                    "Reorder Y/N": "No",
                    "Reorder Date": "",
                    "Section": "A-1"
                },
                {
                    "Remedy Name": "Belladonna",
                    "Potency": "200C", 
                    "BOX Number": "B07",
                    "Type": "Tincture",
                    "Bottle Size": "15ml",
                    "BottleCapColor": "Red",
                    "Manufacturer Brand": "Hyland's",
                    "Available": "Yes",
                    "Reorder Y/N": "No",
                    "Reorder Date": "",
                    "Section": "B-2"
                },
                {
                    "Remedy Name": "Aconitum Napellus",
                    "Potency": "30C",
                    "BOX Number": "B03",
                    "Type": "Pellets", 
                    "Bottle Size": "15ml",
                    "BottleCapColor": "Green",
                    "Manufacturer Brand": "Boiron",
                    "Available": "No",
                    "Reorder Y/N": "Yes",
                    "Reorder Date": "2023-08-15",
                    "Section": "C-1"
                }
            ];
            
            performSearch();
        }
        
        // Perform search
        function performSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (remediesData.length === 0) {
                resultsContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">No data available</div>';
                return;
            }
            
            let results = remediesData;
            
            if (searchTerm) {
                results = remediesData.filter(remedy => {
                    const name = (remedy['Remedy Name'] || '').toLowerCase();
                    const potency = (remedy['Potency'] || '').toLowerCase();
                    
                    return name.includes(searchTerm) || potency.includes(searchTerm);
                });
            }
            
            displayResults(results);
        }
        
        // Display results
        function displayResults(results) {
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">No remedies found</div>';
                detailsPanel.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">Select a remedy to view details</div>';
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            results.forEach((remedy, index) => {
                const isAvailable = remedy['Available'] === 'Yes';
                const item = document.createElement('div');
                item.className = `remedy-item ${isAvailable ? 'available' : 'unavailable'}`;
                
                item.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        ${remedy['Remedy Name']} ${remedy['Potency']}
                        <span style="color: ${isAvailable ? '#27ae60' : '#e74c3c'}; font-size: 0.9em;">
                            (${isAvailable ? 'Available' : 'Out of Stock'})
                        </span>
                    </div>
                    <div style="color: #666; font-size: 0.9em;">
                        Box: ${remedy['BOX Number'] || 'N/A'} | Section: ${remedy['Section'] || 'N/A'}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    // Remove selection from all items
                    document.querySelectorAll('.remedy-item').forEach(i => {
                        i.style.background = '';
                    });
                    
                    // Highlight selected item
                    item.style.background = '#f0f8ff';
                    
                    // Show details
                    showRemedyDetails(remedy);
                });
                
                resultsContainer.appendChild(item);
            });
        }
        
        // Show remedy details
        function showRemedyDetails(remedy) {
            const isAvailable = remedy['Available'] === 'Yes';
            const remedyName = (remedy['Remedy Name'] || '').toLowerCase().replace(/\s+/g, '-');
            const detailUrl = `https://www.materiamedica.info/en/materia-medica/john-henry-clarke/${remedyName}`;
            
            detailsPanel.innerHTML = `
                <h3>${remedy['Remedy Name']} ${remedy['Potency']}</h3>
                
                <div class="info-row">
                    <span class="label">Status:</span>
                    <span style="color: ${isAvailable ? '#27ae60' : '#e74c3c'}">
                        ${isAvailable ? 'In Stock' : 'Out of Stock'}
                    </span>
                </div>
                
                <div class="info-row">
                    <span class="label">Box Number:</span>
                    <span>${remedy['BOX Number'] || 'N/A'}</span>
                </div>
                
                <div class="info-row">
                    <span class="label">Section:</span>
                    <span>${remedy['Section'] || 'N/A'}</span>
                </div>
                
                <div class="info-row">
                    <span class="label">Type:</span>
                    <span>${remedy['Type'] || 'N/A'}</span>
                </div>
                
                <div class="info-row">
                    <span class="label">Bottle Size:</span>
                    <span>${remedy['Bottle Size'] || 'N/A'}</span>
                </div>
                
                <div class="info-row">
                    <span class="label">Cap Color:</span>
                    <span>${remedy['BottleCapColor'] || 'N/A'}</span>
                </div>
                
                <div class="info-row">
                    <span class="label">Brand:</span>
                    <span>${remedy['Manufacturer Brand'] || 'N/A'}</span>
                </div>
                
                <div class="info-row">
                    <span class="label">Reorder Needed:</span>
                    <span>${remedy['Reorder Y/N'] || 'N/A'}</span>
                </div>
                
                <div class="info-row">
                    <span class="label">Reorder Date:</span>
                    <span>${remedy['Reorder Date'] || 'N/A'}</span>
                </div>
                
                ${isAvailable ? `
                    <div style="margin-top: 20px;">
                        <iframe 
                            src="${detailUrl}" 
                            style="width: 100%; height: 300px; border: 1px solid #ddd; border-radius: 5px;">
                        </iframe>
                    </div>
                ` : `
                    <div style="margin-top: 20px; color: #e74c3c;">
                        Detailed information unavailable for out-of-stock remedies
                    </div>
                `}
            `;
        }
        
        // Show status message
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        // Load data immediately
        loadData();
    </script>
</body>
</html>
